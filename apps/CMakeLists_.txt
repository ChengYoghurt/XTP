cmake_minimum_required(VERSION 3.12)

project(KuafuApps
        VERSION 0.1
        DESCRIPTION "Kuafu apps"
        LANGUAGES C CXX
)

if(POLICY CMP0076)
  cmake_policy(SET CMP0076 NEW)
endif()

# enable c++17 globally
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# add directory of FindHdf5.cmake
include(${CMAKE_SOURCE_DIR}/cmake/FindHdf5.cmake)

set(XTP_DIR "${CMAKE_SOURCE_DIR}/XTP/")
find_package(XTP REQUIRED)

# list and compile executable
list(APPEND target_apps "main")

if ("main" IN_LIST target_apps)
    set(target_name "main")
    add_executable(${target_name})
    target_sources(
        ${target_name}
    PUBLIC
        ${target_name}.cpp
        ${CMAKE_SOURCE_DIR}/src/quote_spi.cpp

    #or
    message(STATUS "broker_apis = ${broker_apis}.")
    foreach(api ${broker_apis})
    message(STATUS "Compile with AdaptedAPI::${api}")
    set(AdaptedTrader Adapted.${api})
    add_executable(${AdaptedTrader})
        target_sources(
            ${AdaptedTrader}
        PRIVATE
            main.cpp
            ${CMAKE_SOURCE_DIR}/src/quote_spi.cpp
        )

    )
    target_include_directories(
        ${target_name}
    PUBLIC
        $<BUILD_INTERFACE:${CMAKE_SOURCE_DIR}/include>
        $<INSTALL_INTERFACE:include>
    )

    target_link_directories(
        ${target_name}
    PUBLIC
        $<BUILD_INTERFACE:${CMAKE_SOURCE_DIR}/lib/WCTrader>
        $<INSTALL_INTERFACE:lib/WCTrader>
    )

    target_link_libraries(
        ${target_name}
    PUBLIC
        LogConfig::LogConfig
        Threads::Threads
        Kuafu::Kuafu
        XTP::XTP
        WCTrader
    )
    install(TARGETS ${target_name} DESTINATION bin)
endif()

if ("ManualWCTrader" IN_LIST target_apps)
    foreach(api ${broker_apis})
        message(STATUS "Compile with AdaptedAPI::${api}")
        set(AdaptedWCTrader ManualWCTrader.${api})
        add_executable(${AdaptedWCTrader})
        target_sources(
            ${AdaptedWCTrader}
        PRIVATE
            ManualWCTrader/ManualWCTrader.cpp
            ManualWCTrader/CommandProcessor.cpp
            ManualWCTrader/CommandExecutor.cpp
        )
        target_include_directories(
            ${AdaptedWCTrader}
        PUBLIC
            $<BUILD_INTERFACE:${CMAKE_SOURCE_DIR}/include>
            $<BUILD_INTERFACE:${CMAKE_SOURCE_DIR}/include/Brokers/${api}>
            $<BUILD_INTERFACE:${CMAKE_SOURCE_DIR}/app/ManualWCTrader>
        )
        target_link_libraries(
            ${AdaptedWCTrader}
        PUBLIC
            Threads::Threads
            LogConfig::LogConfig
            WCTrader::WCTrader
            AdaptedApi::${api}
        )
    endforeach()
    file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/ManualWCTrader/Config/ManualWCTraderLogConfig.yaml DESTINATION ${CMAKE_BINARY_DIR}/Config)
    file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/ManualWCTrader/Config/ManualWCTraderConfig.yaml DESTINATION ${CMAKE_BINARY_DIR}/Config)
    file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/ManualWCTrader/Config/TradeXAlgoParams.yaml DESTINATION ${CMAKE_BINARY_DIR}/Config)
    file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/ManualWCTrader/Config/RiskManagement.yaml DESTINATION ${CMAKE_BINARY_DIR}/Config)
endif()
